@model AssetManagement.Controllers.PaginatedList<AssetManagement.Models.Equipment>
@{
    ViewData["Title"] = "Equipment";
}

<style>
    .filter-button {
        padding: 2px 6px;
        font-size: 0.75rem;
        border-radius: 4px;
    }
    
    .filter-button.active {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .filter-button:hover {
        background-color: #e9ecef;
    }
    
    .filter-button.active:hover {
        background-color: #0056b3;
    }
    
    .dropdown-menu {
        min-width: 200px;
    }
    
    .dropdown-item.active {
        background-color: #007bff;
        color: white;
    }
    
    .table th {
        position: relative;
    }
    
    .dropdown-menu input[type="text"] {
        border: 1px solid #dee2e6;
        border-radius: 4px;
        font-size: 0.875rem;
    }
    
    .dropdown-menu input[type="text"]:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    .filter-item {
        transition: all 0.2s ease;
    }
    
    .filter-item:hover {
        background-color: #f8f9fa;
    }
    
    /* Master search suggestions styling */
    #searchSuggestions {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        max-height: 300px;
        overflow-y: auto;
        z-index: 1050;
    }
    
    .suggestion-item {
        transition: background-color 0.15s ease-in-out;
    }
    
    .suggestion-item:hover {
        background-color: #f8f9fa;
    }
    
    .suggestion-item:last-child {
        border-bottom: none !important;
    }
    
    /* Search input focus styling */
    #searchInput:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    /* Master search icon in placeholder */
    #searchInput::placeholder {
        color: #6c757d;
        opacity: 1;
    }
</style>

<div class="container-fluid">
    @Html.AntiForgeryToken()
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">Equipment</h1>
            <p class="text-muted mb-0">Manage IT equipment inventory</p>
        </div>
        <a asp-action="Create" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Add Equipment
        </a>
    </div>

    <!-- Search and Filter Form -->
    <div class="card mb-4">
        <div class="card-body">
            <form asp-action="Index" method="get" class="row g-3">
                <!-- Search Input -->
                <div class="col-md-6">
                    <div class="input-group">
                        <input type="text" class="form-control" id="searchInput" name="SearchString" value="@ViewData["CurrentFilter"]" placeholder="🔍 Master search: OATH Tag, Serial, Net Name, User, Model, Manufacturer, Department, Location..." autocomplete="off">
                        <div id="searchSuggestions" class="position-absolute bg-white border rounded shadow-sm" style="top: 100%; left: 0; right: 0; z-index: 1000; display: none; max-height: 200px; overflow-y: auto;"></div>
                        <button class="btn btn-outline-secondary" type="submit">
                            <i class="bi bi-search"></i>
                        </button>
                        @if (!string.IsNullOrEmpty(ViewData["CurrentFilter"]?.ToString()))
                        {
                            <a asp-action="Index" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> Clear
                            </a>
                        }
                    </div>
                </div>
                
                <!-- Filter Dropdowns -->
                <div class="col-md-6">
                    <div class="row g-2">
                        <div class="col-md-4">
                            <select name="categoryFilter" class="form-select form-select-sm" onchange="this.form.submit()">
                                <option value="">All Categories</option>
                                @foreach (var category in ViewData["CategoryOptions"] as List<string> ?? new List<string>())
                                {
                                    if (category == ViewData["CategoryFilter"]?.ToString())
                                    {
                                        <option value="@category" selected>@category</option>
                                    }
                                    else
                                    {
                                        <option value="@category">@category</option>
                                    }
                                }
                            </select>
                        </div>
                        <div class="col-md-4">
                            <select name="statusFilter" class="form-select form-select-sm" onchange="this.form.submit()">
                                <option value="">All Statuses</option>
                                @foreach (var status in ViewData["StatusOptions"] as List<string> ?? new List<string>())
                                {
                                    if (status == ViewData["StatusFilter"]?.ToString())
                                    {
                                        <option value="@status" selected>@status</option>
                                    }
                                    else
                                    {
                                        <option value="@status">@status</option>
                                    }
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select name="departmentFilter" class="form-select form-select-sm" onchange="this.form.submit()">
                                <option value="">All Units</option>
                                @foreach (var dept in ViewData["DepartmentOptions"] as List<string> ?? new List<string>())
                                {
                                    if (dept == ViewData["DepartmentFilter"]?.ToString())
                                    {
                                        <option value="@dept" selected>@dept</option>
                                    }
                                    else
                                    {
                                        <option value="@dept">@dept</option>
                                    }
                                }
                            </select>
                        </div>

                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Equipment List -->
    <div class="card">
        <div class="card-body">
            @if (!Model.Any())
            {
                <div class="text-center py-5">
                    <i class="bi bi-laptop display-1 text-muted"></i>
                    <h4 class="text-muted mt-3">No Equipment Found</h4>
                    <p class="text-muted">@(string.IsNullOrEmpty(ViewData["CurrentFilter"]?.ToString()) ? "Add your first piece of equipment to get started." : "No equipment matches your search criteria.")</p>
                    @if (string.IsNullOrEmpty(ViewData["CurrentFilter"]?.ToString()))
                    {
                        <a asp-action="Create" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> Add Equipment
                        </a>
                    }
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>
                                    <div class="d-flex align-items-center">
                                        <a asp-action="Index" asp-route-sortOrder="@ViewData["OATHTagSortParm"]" asp-route-currentFilter="@ViewData["CurrentFilter"]" asp-route-categoryFilter="@ViewData["CategoryFilter"]" asp-route-statusFilter="@ViewData["StatusFilter"]" asp-route-departmentFilter="@ViewData["DepartmentFilter"]" class="text-decoration-none me-2">
                                            OATH Tag
                                            @if (ViewData["CurrentSort"]?.ToString() == "oath_tag_desc")
                                            {
                                                <i class="bi bi-sort-alpha-down ms-1"></i>
                                            }
                                            else if (ViewData["CurrentSort"]?.ToString() == "")
                                            {
                                                <i class="bi bi-sort-alpha-up ms-1"></i>
                                            }
                                            else
                                            {
                                                <i class="bi bi-arrow-down-up ms-1 text-muted"></i>
                                            }
                                        </a>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle filter-button @(!string.IsNullOrEmpty(ViewData["OathTagFilter"]?.ToString()) ? "active" : "")" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                <i class="bi bi-funnel"></i>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end" style="max-height: 300px; overflow-y: auto; min-width: 250px;">
                                                <li><h6 class="dropdown-header">Filter by OATH Tag</h6></li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li>
                                                    <div class="px-3 py-2">
                                                        <input type="text" class="form-control form-control-sm" placeholder="Search OATH tags..." 
                                                               onkeyup="filterDropdownItems(this, 'oath-tag-filter-items')">
                                                    </div>
                                                </li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li>
                                                    <div class="px-3 py-2" id="oath-tag-filter-items">
                                                        @foreach (var tag in ViewData["OathTagOptions"] as List<string> ?? new List<string>())
                                                        {
                                                            <div class="filter-item">
                                                                <a class="dropdown-item @(tag == ViewData["OathTagFilter"]?.ToString() ? "active" : "")" 
                                                                   href="@Url.Action("Index", new { 
                                                                       sortOrder = ViewData["CurrentSort"], 
                                                                       currentFilter = ViewData["CurrentFilter"], 
                                                                       categoryFilter = ViewData["CategoryFilter"], 
                                                                       statusFilter = ViewData["StatusFilter"], 
                                                                       departmentFilter = ViewData["DepartmentFilter"], 
                                                                       oathTagFilter = tag 
                                                                   })">
                                                                    @tag
                                                                </a>
                                                            </div>
                                                        }
                                                    </div>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </th>
                                <th>
                                    <div class="d-flex align-items-center">
                                        <a asp-action="Index" asp-route-sortOrder="@ViewData["AssignedToSortParm"]" asp-route-currentFilter="@ViewData["CurrentFilter"]" asp-route-categoryFilter="@ViewData["CategoryFilter"]" asp-route-statusFilter="@ViewData["StatusFilter"]" asp-route-departmentFilter="@ViewData["DepartmentFilter"]" class="text-decoration-none me-2">
                                            Assigned To
                                            @if (ViewData["CurrentSort"]?.ToString() == "assigned_desc")
                                            {
                                                <i class="bi bi-sort-alpha-down ms-1"></i>
                                            }
                                            else if (ViewData["CurrentSort"]?.ToString() == "assigned")
                                            {
                                                <i class="bi bi-sort-alpha-up ms-1"></i>
                                            }
                                            else
                                            {
                                                <i class="bi bi-arrow-down-up ms-1 text-muted"></i>
                                            }
                                        </a>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle filter-button @(!string.IsNullOrEmpty(ViewData["AssignedToFilter"]?.ToString()) ? "active" : "")" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                <i class="bi bi-funnel"></i>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end" style="max-height: 300px; overflow-y: auto; min-width: 250px;">
                                                <li><h6 class="dropdown-header">Filter by Assigned To</h6></li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li>
                                                    <div class="px-3 py-2">
                                                        <input type="text" class="form-control form-control-sm" placeholder="Search users..." 
                                                               onkeyup="filterDropdownItems(this, 'assigned-to-filter-items')">
                                                    </div>
                                                </li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li>
                                                    <div class="px-3 py-2" id="assigned-to-filter-items">
                                                        @foreach (var user in ViewData["AssignedToOptions"] as List<string> ?? new List<string>())
                                                        {
                                                            <div class="filter-item">
                                                                <a class="dropdown-item @(user == ViewData["AssignedToFilter"]?.ToString() ? "active" : "")" 
                                                                   href="@Url.Action("Index", new { 
                                                                       sortOrder = ViewData["CurrentSort"], 
                                                                       currentFilter = ViewData["CurrentFilter"], 
                                                                       categoryFilter = ViewData["CategoryFilter"], 
                                                                       statusFilter = ViewData["StatusFilter"], 
                                                                       departmentFilter = ViewData["DepartmentFilter"], 
                                                                       assignedToFilter = user 
                                                                   })">
                                                                    @user
                                                                </a>
                                                            </div>
                                                        }
                                                    </div>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </th>
                                <th>
                                    <div class="d-flex align-items-center">
                                        <a asp-action="Index" asp-route-sortOrder="@ViewData["CategorySortParm"]" asp-route-currentFilter="@ViewData["CurrentFilter"]" asp-route-categoryFilter="@ViewData["CategoryFilter"]" asp-route-statusFilter="@ViewData["StatusFilter"]" asp-route-departmentFilter="@ViewData["DepartmentFilter"]" class="text-decoration-none me-2">
                                            Category
                                            @if (ViewData["CurrentSort"]?.ToString() == "category_desc")
                                            {
                                                <i class="bi bi-sort-alpha-down ms-1"></i>
                                            }
                                            else if (ViewData["CurrentSort"]?.ToString() == "category")
                                            {
                                                <i class="bi bi-sort-alpha-up ms-1"></i>
                                            }
                                            else
                                            {
                                                <i class="bi bi-arrow-down-up ms-1 text-muted"></i>
                                            }
                                        </a>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle filter-button @(!string.IsNullOrEmpty(ViewData["CategoryFilter"]?.ToString()) ? "active" : "")" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                <i class="bi bi-funnel"></i>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end" style="max-height: 300px; overflow-y: auto; min-width: 250px;">
                                                <li><h6 class="dropdown-header">Filter by Category</h6></li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li>
                                                    <div class="px-3 py-2">
                                                        <input type="text" class="form-control form-control-sm" placeholder="Search categories..." 
                                                               onkeyup="filterDropdownItems(this, 'category-filter-items')">
                                                    </div>
                                                </li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li>
                                                    <div class="px-3 py-2" id="category-filter-items">
                                                        @foreach (var category in ViewData["CategoryOptions"] as List<string> ?? new List<string>())
                                                        {
                                                            <div class="filter-item">
                                                                <a class="dropdown-item @(category == ViewData["CategoryFilter"]?.ToString() ? "active" : "")" 
                                                                   href="@Url.Action("Index", new { 
                                                                       sortOrder = ViewData["CurrentSort"], 
                                                                       currentFilter = ViewData["CurrentFilter"], 
                                                                       categoryFilter = category, 
                                                                       statusFilter = ViewData["StatusFilter"], 
                                                                       departmentFilter = ViewData["DepartmentFilter"] 
                                                                   })">
                                                                    @category
                                                                </a>
                                                            </div>
                                                        }
                                                    </div>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </th>
                                <th>
                                    <div class="d-flex align-items-center">
                                        <a asp-action="Index" asp-route-sortOrder="@ViewData["DepartmentSortParm"]" asp-route-currentFilter="@ViewData["CurrentFilter"]" asp-route-categoryFilter="@ViewData["CategoryFilter"]" asp-route-statusFilter="@ViewData["StatusFilter"]" asp-route-departmentFilter="@ViewData["DepartmentFilter"]" class="text-decoration-none me-2">
                                            Unit
                                            @if (ViewData["CurrentSort"]?.ToString() == "department_desc")
                                            {
                                                <i class="bi bi-sort-alpha-down ms-1"></i>
                                            }
                                            else if (ViewData["CurrentSort"]?.ToString() == "department")
                                            {
                                                <i class="bi bi-sort-alpha-up ms-1"></i>
                                            }
                                            else
                                            {
                                                <i class="bi bi-arrow-down-up ms-1 text-muted"></i>
                                            }
                                        </a>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle filter-button @(!string.IsNullOrEmpty(ViewData["DepartmentFilter"]?.ToString()) ? "active" : "")" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                <i class="bi bi-funnel"></i>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end" style="max-height: 300px; overflow-y: auto; min-width: 250px;">
                                                <li><h6 class="dropdown-header">Filter by Unit</h6></li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li>
                                                    <div class="px-3 py-2">
                                                        <input type="text" class="form-control form-control-sm" placeholder="Search units..." 
                                                               onkeyup="filterDropdownItems(this, 'unit-filter-items')">
                                                    </div>
                                                </li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li>
                                                    <div class="px-3 py-2" id="unit-filter-items">
                                                        @foreach (var dept in ViewData["DepartmentOptions"] as List<string> ?? new List<string>())
                                                        {
                                                            <div class="filter-item">
                                                                <a class="dropdown-item @(dept == ViewData["DepartmentFilter"]?.ToString() ? "active" : "")" 
                                                                   href="@Url.Action("Index", new { 
                                                                       sortOrder = ViewData["CurrentSort"], 
                                                                       currentFilter = ViewData["CurrentFilter"], 
                                                                       categoryFilter = ViewData["CategoryFilter"], 
                                                                       statusFilter = ViewData["StatusFilter"], 
                                                                       departmentFilter = dept 
                                                                   })">
                                                                    @dept
                                                                </a>
                                                            </div>
                                                        }
                                                    </div>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </th>
                                <th>
                                    <div class="d-flex align-items-center">
                                        <a asp-action="Index" asp-route-sortOrder="@ViewData["LocationSortParm"]" asp-route-currentFilter="@ViewData["CurrentFilter"]" asp-route-categoryFilter="@ViewData["CategoryFilter"]" asp-route-statusFilter="@ViewData["StatusFilter"]" asp-route-departmentFilter="@ViewData["DepartmentFilter"]" class="text-decoration-none me-2">
                                            Location
                                            @if (ViewData["CurrentSort"]?.ToString() == "location_desc")
                                            {
                                                <i class="bi bi-sort-alpha-down ms-1"></i>
                                            }
                                            else if (ViewData["CurrentSort"]?.ToString() == "location")
                                            {
                                                <i class="bi bi-sort-alpha-up ms-1"></i>
                                            }
                                            else
                                            {
                                                <i class="bi bi-arrow-down-up ms-1 text-muted"></i>
                                            }
                                        </a>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle filter-button @(!string.IsNullOrEmpty(ViewData["LocationFilter"]?.ToString()) ? "active" : "")" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                <i class="bi bi-funnel"></i>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end" style="max-height: 300px; overflow-y: auto; min-width: 250px;">
                                                <li><h6 class="dropdown-header">Filter by Location</h6></li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li>
                                                    <div class="px-3 py-2">
                                                        <input type="text" class="form-control form-control-sm" placeholder="Search locations..." 
                                                               onkeyup="filterDropdownItems(this, 'location-filter-items')">
                                                    </div>
                                                </li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li>
                                                    <div class="px-3 py-2" id="location-filter-items">
                                                        @foreach (var location in ViewData["LocationOptions"] as List<string> ?? new List<string>())
                                                        {
                                                            <div class="filter-item">
                                                                <a class="dropdown-item @(location == ViewData["LocationFilter"]?.ToString() ? "active" : "")" 
                                                                   href="@Url.Action("Index", new { 
                                                                       sortOrder = ViewData["CurrentSort"], 
                                                                       currentFilter = ViewData["CurrentFilter"], 
                                                                       categoryFilter = ViewData["CategoryFilter"], 
                                                                       statusFilter = ViewData["StatusFilter"], 
                                                                       departmentFilter = ViewData["DepartmentFilter"], 
                                                                       locationFilter = location,
                                                                       floorFilter = ViewData["FloorFilter"]
                                                                   })">
                                                                    @location
                                                                </a>
                                                            </div>
                                                        }
                                                    </div>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </th>
                                <th>
                                    <div class="d-flex align-items-center">
                                        <a asp-action="Index" asp-route-sortOrder="@ViewData["FloorSortParm"]" asp-route-currentFilter="@ViewData["CurrentFilter"]" asp-route-categoryFilter="@ViewData["CategoryFilter"]" asp-route-statusFilter="@ViewData["StatusFilter"]" asp-route-departmentFilter="@ViewData["DepartmentFilter"]" asp-route-locationFilter="@ViewData["LocationFilter"]" class="text-decoration-none me-2">
                                            Floor
                                            @if (ViewData["CurrentSort"]?.ToString() == "floor_desc")
                                            {
                                                <i class="bi bi-sort-alpha-down ms-1"></i>
                                            }
                                            else if (ViewData["CurrentSort"]?.ToString() == "floor")
                                            {
                                                <i class="bi bi-sort-alpha-up ms-1"></i>
                                            }
                                            else
                                            {
                                                <i class="bi bi-arrow-down-up ms-1 text-muted"></i>
                                            }
                                        </a>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle filter-button @(!string.IsNullOrEmpty(ViewData["FloorFilter"]?.ToString()) ? "active" : "")" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                <i class="bi bi-funnel"></i>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end" style="max-height: 300px; overflow-y: auto; min-width: 250px;">
                                                <li><h6 class="dropdown-header">Filter by Floor</h6></li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li>
                                                    <div class="px-3 py-2">
                                                        <input type="text" class="form-control form-control-sm" placeholder="Search floors..." 
                                                               onkeyup="filterDropdownItems(this, 'floor-filter-items')">
                                                    </div>
                                                </li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li>
                                                    <div class="px-3 py-2" id="floor-filter-items">
                                                        @foreach (var floor in ViewData["FloorOptions"] as List<string> ?? new List<string>())
                                                        {
                                                            <div class="filter-item">
                                                                <a class="dropdown-item @(floor == ViewData["FloorFilter"]?.ToString() ? "active" : "")" 
                                                                   href="@Url.Action("Index", new { 
                                                                       sortOrder = ViewData["CurrentSort"], 
                                                                       currentFilter = ViewData["CurrentFilter"], 
                                                                       categoryFilter = ViewData["CategoryFilter"], 
                                                                       statusFilter = ViewData["StatusFilter"], 
                                                                       departmentFilter = ViewData["DepartmentFilter"], 
                                                                       locationFilter = ViewData["LocationFilter"],
                                                                       floorFilter = floor 
                                                                   })">
                                                                    @floor
                                                                </a>
                                                            </div>
                                                        }
                                                    </div>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </th>
                                <th>
                                    <div class="d-flex align-items-center">
                                        <a asp-action="Index" asp-route-sortOrder="@ViewData["StatusSortParm"]" asp-route-currentFilter="@ViewData["CurrentFilter"]" asp-route-categoryFilter="@ViewData["CategoryFilter"]" asp-route-statusFilter="@ViewData["StatusFilter"]" asp-route-departmentFilter="@ViewData["DepartmentFilter"]" class="text-decoration-none me-2">
                                            Status
                                            @if (ViewData["CurrentSort"]?.ToString() == "status_desc")
                                            {
                                                <i class="bi bi-sort-alpha-down ms-1"></i>
                                            }
                                            else if (ViewData["CurrentSort"]?.ToString() == "status")
                                            {
                                                <i class="bi bi-sort-alpha-up ms-1"></i>
                                            }
                                            else
                                            {
                                                <i class="bi bi-arrow-down-up ms-1 text-muted"></i>
                                            }
                                        </a>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle filter-button @(!string.IsNullOrEmpty(ViewData["StatusFilter"]?.ToString()) ? "active" : "")" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                <i class="bi bi-funnel"></i>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end" style="max-height: 300px; overflow-y: auto; min-width: 250px;">
                                                <li><h6 class="dropdown-header">Filter by Status</h6></li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li>
                                                    <div class="px-3 py-2">
                                                        <input type="text" class="form-control form-control-sm" placeholder="Search statuses..." 
                                                               onkeyup="filterDropdownItems(this, 'status-filter-items')">
                                                    </div>
                                                </li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li>
                                                    <div class="px-3 py-2" id="status-filter-items">
                                                        @foreach (var status in ViewData["StatusOptions"] as List<string> ?? new List<string>())
                                                        {
                                                            <div class="filter-item">
                                                                <a class="dropdown-item @(status == ViewData["StatusFilter"]?.ToString() ? "active" : "")" 
                                                                   href="@Url.Action("Index", new { 
                                                                       sortOrder = ViewData["CurrentSort"], 
                                                                       currentFilter = ViewData["CurrentFilter"], 
                                                                       categoryFilter = ViewData["CategoryFilter"], 
                                                                       statusFilter = status, 
                                                                       departmentFilter = ViewData["DepartmentFilter"] 
                                                                   })">
                                                                    @status
                                                                </a>
                                                            </div>
                                                        }
                                                    </div>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </th>
                                <th>
                                    <div class="d-flex align-items-center">
                                        <a asp-action="Index" asp-route-sortOrder="@ViewData["NetNameSortParm"]" asp-route-currentFilter="@ViewData["CurrentFilter"]" asp-route-categoryFilter="@ViewData["CategoryFilter"]" asp-route-statusFilter="@ViewData["StatusFilter"]" asp-route-departmentFilter="@ViewData["DepartmentFilter"]" class="text-decoration-none me-2">
                                            Net Name
                                            @if (ViewData["CurrentSort"]?.ToString() == "netname_desc")
                                            {
                                                <i class="bi bi-sort-alpha-down ms-1"></i>
                                            }
                                            else if (ViewData["CurrentSort"]?.ToString() == "netname")
                                            {
                                                <i class="bi bi-sort-alpha-up ms-1"></i>
                                            }
                                            else
                                            {
                                                <i class="bi bi-arrow-down-up ms-1 text-muted"></i>
                                            }
                                        </a>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle filter-button @(!string.IsNullOrEmpty(ViewData["NetNameFilter"]?.ToString()) ? "active" : "")" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                <i class="bi bi-funnel"></i>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end" style="max-height: 300px; overflow-y: auto; min-width: 250px;">
                                                <li><h6 class="dropdown-header">Filter by Net Name</h6></li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li>
                                                    <div class="px-3 py-2">
                                                        <input type="text" class="form-control form-control-sm" placeholder="Search net names..." 
                                                               onkeyup="filterDropdownItems(this, 'netname-filter-items')">
                                                    </div>
                                                </li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li>
                                                    <div class="px-3 py-2" id="netname-filter-items">
                                                        @foreach (var netName in ViewData["NetNameOptions"] as List<string> ?? new List<string>())
                                                        {
                                                            <div class="filter-item">
                                                                <a class="dropdown-item @(netName == ViewData["NetNameFilter"]?.ToString() ? "active" : "")" 
                                                                   href="@Url.Action("Index", new { 
                                                                       sortOrder = ViewData["CurrentSort"], 
                                                                       currentFilter = ViewData["CurrentFilter"], 
                                                                       categoryFilter = ViewData["CategoryFilter"], 
                                                                       statusFilter = ViewData["StatusFilter"], 
                                                                       departmentFilter = ViewData["DepartmentFilter"], 
                                                                       netNameFilter = netName 
                                                                   })">
                                                                    @netName
                                                                </a>
                                                            </div>
                                                        }
                                                    </div>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </th>
                                <th>
                                    <div class="d-flex align-items-center">
                                        <a asp-action="Index" asp-route-sortOrder="@ViewData["ModelSortParm"]" asp-route-currentFilter="@ViewData["CurrentFilter"]" asp-route-categoryFilter="@ViewData["CategoryFilter"]" asp-route-statusFilter="@ViewData["StatusFilter"]" asp-route-departmentFilter="@ViewData["DepartmentFilter"]" class="text-decoration-none me-2">
                                            Model
                                            @if (ViewData["CurrentSort"]?.ToString() == "model_desc")
                                            {
                                                <i class="bi bi-sort-alpha-down ms-1"></i>
                                            }
                                            else if (ViewData["CurrentSort"]?.ToString() == "model")
                                            {
                                                <i class="bi bi-sort-alpha-up ms-1"></i>
                                            }
                                            else
                                            {
                                                <i class="bi bi-arrow-down-up ms-1 text-muted"></i>
                                            }
                                        </a>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle filter-button @(!string.IsNullOrEmpty(ViewData["ModelFilter"]?.ToString()) ? "active" : "")" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                <i class="bi bi-funnel"></i>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end" style="max-height: 300px; overflow-y: auto; min-width: 250px;">
                                                <li><h6 class="dropdown-header">Filter by Model</h6></li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li>
                                                    <div class="px-3 py-2">
                                                        <input type="text" class="form-control form-control-sm" placeholder="Search models..." 
                                                               onkeyup="filterDropdownItems(this, 'model-filter-items')">
                                                    </div>
                                                </li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li>
                                                    <div class="px-3 py-2" id="model-filter-items">
                                                        @foreach (var model in ViewData["ModelOptions"] as List<string> ?? new List<string>())
                                                        {
                                                            <div class="filter-item">
                                                                <a class="dropdown-item @(model == ViewData["ModelFilter"]?.ToString() ? "active" : "")" 
                                                                   href="@Url.Action("Index", new { 
                                                                       sortOrder = ViewData["CurrentSort"], 
                                                                       currentFilter = ViewData["CurrentFilter"], 
                                                                       categoryFilter = ViewData["CategoryFilter"], 
                                                                       statusFilter = ViewData["StatusFilter"], 
                                                                       departmentFilter = ViewData["DepartmentFilter"], 
                                                                       modelFilter = model 
                                                                   })">

                                                                </a>
                                                            </div>
                                                        }
                                                    </div>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </th>
                                <th>
                                    <div class="d-flex align-items-center">
                                        <a asp-action="Index" asp-route-sortOrder="@ViewData["SerialNumberSortParm"]" asp-route-currentFilter="@ViewData["CurrentFilter"]" asp-route-categoryFilter="@ViewData["CategoryFilter"]" asp-route-statusFilter="@ViewData["StatusFilter"]" asp-route-departmentFilter="@ViewData["DepartmentFilter"]" class="text-decoration-none me-2">
                                            Serial Number
                                            @if (ViewData["CurrentSort"]?.ToString() == "serialnumber_desc")
                                            {
                                                <i class="bi bi-sort-alpha-down ms-1"></i>
                                            }
                                            else if (ViewData["CurrentSort"]?.ToString() == "serialnumber")
                                            {
                                                <i class="bi bi-sort-alpha-up ms-1"></i>
                                            }
                                            else
                                            {
                                                <i class="bi bi-arrow-down-up ms-1 text-muted"></i>
                                            }
                                        </a>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle filter-button @(!string.IsNullOrEmpty(ViewData["SerialNumberFilter"]?.ToString()) ? "active" : "")" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                <i class="bi bi-funnel"></i>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end" style="max-height: 300px; overflow-y: auto; min-width: 250px;">
                                                <li><h6 class="dropdown-header">Filter by Serial Number</h6></li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li>
                                                    <div class="px-3 py-2">
                                                        <input type="text" class="form-control form-control-sm" placeholder="Search serial numbers..." 
                                                               onkeyup="filterDropdownItems(this, 'serialnumber-filter-items')">
                                                    </div>
                                                </li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li>
                                                    <div class="px-3 py-2" id="serialnumber-filter-items">
                                                        @foreach (var serialNumber in ViewData["SerialNumberOptions"] as List<string> ?? new List<string>())
                                                        {
                                                            <div class="filter-item">
                                                                <a class="dropdown-item @(serialNumber == ViewData["SerialNumberFilter"]?.ToString() ? "active" : "")" 
                                                                   href="@Url.Action("Index", new { 
                                                                       sortOrder = ViewData["CurrentSort"], 
                                                                       currentFilter = ViewData["CurrentFilter"], 
                                                                       categoryFilter = ViewData["CategoryFilter"], 
                                                                       statusFilter = ViewData["StatusFilter"], 
                                                                       departmentFilter = ViewData["DepartmentFilter"], 
                                                                       serialNumberFilter = serialNumber 
                                                                   })">
                                                                    @serialNumber
                                                                </a>
                                                            </div>
                                                        }
                                                    </div>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Debug: Equipment IDs on this page: @string.Join(", ", Model.Select(e => e.Id)) -->
                            @foreach (var item in Model)
                            {
                                <tr class="equipment-row" data-equipment-id="@item.Id" data-oath-tag="@item.OATH_Tag">
                                    <!-- Debug: Equipment ID @item.Id, OATH Tag @item.OATH_Tag -->
                                    <td class="editable-cell" data-field="OATH_Tag" data-value="@item.OATH_Tag" style="cursor: pointer;">@item.OATH_Tag</td>
                                    <td class="editable-cell" data-field="Assigned_User_Name" data-value="@(item.Assigned_User_Name ?? "")" style="cursor: pointer;">@(item.Assigned_User_Name ?? "Unassigned")</td>
                                    <td class="editable-cell" data-field="AssetCategoryId" data-value="@(item.AssetCategory?.Name ?? "")" style="cursor: pointer;">@(item.AssetCategory?.Name ?? "Unknown")</td>
                                    <td class="editable-cell" data-field="Department" data-value="@(item.Department ?? "")" style="cursor: pointer;">@(item.Department ?? "Unknown")</td>
                                    <td class="editable-cell" data-field="CurrentLocationId" data-value="@(item.CurrentLocation?.Name ?? "Unknown")" style="cursor: pointer;">@(item.CurrentLocation?.Name ?? "Unknown")</td>
                                    <td class="editable-cell" data-field="CurrentFloorPlanId" data-value="@(item.CurrentFloorPlan?.FloorName ?? "Unknown")" style="cursor: pointer;">@(item.CurrentFloorPlan?.FloorName ?? "Unknown")</td>
                                    <td class="editable-cell" data-field="CurrentStatusId" data-value="@(item.CurrentStatus?.Name ?? "")" style="cursor: pointer;">@(item.CurrentStatus?.Name ?? "Unknown")</td>
                                    <td class="editable-cell" data-field="NetName" data-value="@(item.TechnologyConfiguration?.NetName ?? "")" style="cursor: pointer;">@(item.TechnologyConfiguration?.NetName ?? "N/A")</td>
                                    <td class="editable-cell" data-field="Model" data-value="@(item.Model ?? "")" style="cursor: pointer;">@(item.Model ?? "Unknown")</td>
                                    <td class="editable-cell" data-field="Serial_Number" data-value="@(item.Serial_Number ?? "")" style="cursor: pointer;">@(item.Serial_Number ?? "N/A")</td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a asp-action="Details" asp-route-id="@item.Id" class="btn btn-outline-primary" title="View Details">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-outline-secondary" title="Edit">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            <a asp-action="Delete" asp-route-id="@item.Id" class="btn btn-outline-danger" title="Delete">
                                                <i class="bi bi-trash"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div class="d-flex align-items-center">
                        <span class="text-muted me-3">
                            @{
                                var currentPageSize = ViewData["CurrentPageSize"] as int? ?? 20;
                                var startItem = (Model.PageIndex - 1) * currentPageSize + 1;
                                var endItem = Math.Min(Model.PageIndex * currentPageSize, Model.TotalCount);
                            }
                            Showing @startItem to @endItem of @Model.TotalCount entries
                        </span>
                        <div class="d-flex align-items-center">
                            <label class="form-label me-2 mb-0">Show:</label>
                            <select class="form-select form-select-sm" style="width: auto;" onchange="changePageSize(this.value)">
                                @{
                                    var pageSizeOptions = new List<int> { 10, 25, 50, 100 };
                                    var pageSize = ViewData["CurrentPageSize"] as int? ?? 20;
                                }
                                @foreach (var size in pageSizeOptions)
                                {
                                    if (size == pageSize)
                                    {
                                        <option value="@size" selected>@size</option>
                                    }
                                    else
                                    {
                                        <option value="@size">@size</option>
                                    }
                                }
                            </select>
                            <span class="text-muted ms-2">entries per page</span>
                        </div>
                    </div>
                    
                    <nav aria-label="Equipment pagination">
                        <ul class="pagination pagination-sm mb-0">
                            @if (Model.HasPreviousPage)
                            {
                                <li class="page-item">
                                    <a class="page-link" asp-action="Index" asp-route-sortOrder="@ViewData["CurrentSort"]" asp-route-pageNumber="@(Model.PageIndex - 1)" asp-route-currentFilter="@ViewData["CurrentFilter"]" asp-route-categoryFilter="@ViewData["CategoryFilter"]" asp-route-statusFilter="@ViewData["StatusFilter"]" asp-route-departmentFilter="@ViewData["DepartmentFilter"]" asp-route-oathTagFilter="@ViewData["OathTagFilter"]" asp-route-assignedToFilter="@ViewData["AssignedToFilter"]" asp-route-locationFilter="@ViewData["LocationFilter"]" asp-route-netNameFilter="@ViewData["NetNameFilter"]" asp-route-modelFilter="@ViewData["ModelFilter"]">
                                        <i class="bi bi-chevron-left"></i>
                                    </a>
                                </li>
                            }
                            else
                            {
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="bi bi-chevron-left"></i></span>
                                </li>
                            }

                            @{
                                var startPage = Math.Max(1, Model.PageIndex - 2);
                                var endPage = Math.Min(Model.TotalPages, Model.PageIndex + 2);
                            }

                            @if (startPage > 1)
                            {
                                <li class="page-item">
                                    <a class="page-link" asp-action="Index" asp-route-sortOrder="@ViewData["CurrentSort"]" asp-route-pageNumber="1" asp-route-currentFilter="@ViewData["CurrentFilter"]" asp-route-categoryFilter="@ViewData["CategoryFilter"]" asp-route-statusFilter="@ViewData["StatusFilter"]" asp-route-departmentFilter="@ViewData["DepartmentFilter"]" asp-route-oathTagFilter="@ViewData["OathTagFilter"]" asp-route-assignedToFilter="@ViewData["AssignedToFilter"]" asp-route-locationFilter="@ViewData["LocationFilter"]" asp-route-netNameFilter="@ViewData["NetNameFilter"]" asp-route-modelFilter="@ViewData["ModelFilter"]">1</a>
                                </li>
                                @if (startPage > 2)
                                {
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                }
                            }

                            @for (int i = startPage; i <= endPage; i++)
                            {
                                if (i == Model.PageIndex)
                                {
                                    <li class="page-item active">
                                        <span class="page-link">@i</span>
                                    </li>
                                }
                                else
                                {
                                    <li class="page-item">
                                        <a class="page-link" asp-action="Index" asp-route-sortOrder="@ViewData["CurrentSort"]" asp-route-pageNumber="@i" asp-route-currentFilter="@ViewData["CurrentFilter"]" asp-route-categoryFilter="@ViewData["CategoryFilter"]" asp-route-statusFilter="@ViewData["StatusFilter"]" asp-route-departmentFilter="@ViewData["DepartmentFilter"]" asp-route-oathTagFilter="@ViewData["OathTagFilter"]" asp-route-assignedToFilter="@ViewData["AssignedToFilter"]" asp-route-locationFilter="@ViewData["LocationFilter"]" asp-route-netNameFilter="@ViewData["NetNameFilter"]" asp-route-modelFilter="@ViewData["ModelFilter"]">@i</a>
                                    </li>
                                }
                            }

                            @if (endPage < Model.TotalPages)
                            {
                                @if (endPage < Model.TotalPages - 1)
                                {
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                }
                                <li class="page-item">
                                    <a class="page-link" asp-action="Index" asp-route-sortOrder="@ViewData["CurrentSort"]" asp-route-pageNumber="@Model.TotalPages" asp-route-currentFilter="@ViewData["CurrentFilter"]" asp-route-categoryFilter="@ViewData["CategoryFilter"]" asp-route-statusFilter="@ViewData["StatusFilter"]" asp-route-departmentFilter="@ViewData["DepartmentFilter"]" asp-route-oathTagFilter="@ViewData["OathTagFilter"]" asp-route-assignedToFilter="@ViewData["AssignedToFilter"]" asp-route-locationFilter="@ViewData["LocationFilter"]" asp-route-netNameFilter="@ViewData["NetNameFilter"]" asp-route-modelFilter="@ViewData["ModelFilter"]">@Model.TotalPages</a>
                                </li>
                            }

                            @if (Model.HasNextPage)
                            {
                                <li class="page-item">
                                    <a class="page-link" asp-action="Index" asp-route-sortOrder="@ViewData["CurrentSort"]" asp-route-pageNumber="@(Model.PageIndex + 1)" asp-route-currentFilter="@ViewData["CurrentFilter"]" asp-route-categoryFilter="@ViewData["CategoryFilter"]" asp-route-statusFilter="@ViewData["StatusFilter"]" asp-route-departmentFilter="@ViewData["DepartmentFilter"]" asp-route-oathTagFilter="@ViewData["OathTagFilter"]" asp-route-assignedToFilter="@ViewData["AssignedToFilter"]" asp-route-locationFilter="@ViewData["LocationFilter"]" asp-route-netNameFilter="@ViewData["NetNameFilter"]" asp-route-modelFilter="@ViewData["ModelFilter"]">
                                        <i class="bi bi-chevron-right"></i>
                                    </a>
                                </li>
                            }
                            else
                            {
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="bi bi-chevron-right"></i></span>
                                </li>
                            }
                        </ul>
                    </nav>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let searchTimeout = null;
        let searchSuggestions = [];

        function filterDropdownItems(input, containerId) {
            const filter = input.value.toLowerCase();
            const container = document.getElementById(containerId);
            const items = container.querySelectorAll('.filter-item');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(filter)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function changePageSize(size) {
            const url = new URL(window.location);
            url.searchParams.set('pageSize', size);
            url.searchParams.set('pageNumber', '1');
            window.location.href = url.toString();
        }

        // Master search functionality
        function initializeMasterSearch() {
            const searchInput = document.getElementById('searchInput');
            const suggestionsContainer = document.getElementById('searchSuggestions');
            
            if (!searchInput) return;

            // Show quick suggestions based on current page data
            function showSuggestions(query) {
                if (!query || query.length < 2) {
                    suggestionsContainer.style.display = 'none';
                    return;
                }

                // Show a "Search all equipment" option
                const suggestionsHtml = `
                    <div class="suggestion-item p-2 border-bottom" style="cursor: pointer;" 
                         onclick="performMasterSearch('${query}')">
                        <div class="d-flex align-items-center">
                            <div class="me-2">
                                <i class="bi bi-search text-primary"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="fw-medium">Search for "${query}"</div>
                                <div class="small text-muted">
                                    Search all equipment across OATH Tag, Serial, Net Name, User, Model, Manufacturer, Department, Location...
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                suggestionsContainer.innerHTML = suggestionsHtml;
                suggestionsContainer.style.display = 'block';
            }

            function performMasterSearch(query) {
                searchInput.value = query;
                suggestionsContainer.style.display = 'none';
                searchInput.form.submit();
            }



            // Handle input events
            searchInput.addEventListener('input', function(e) {
                const query = e.target.value.trim();
                
                // Clear previous timeout
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }

                // Debounce the search
                searchTimeout = setTimeout(() => {
                    showSuggestions(query);
                }, 300);
            });

            // Handle keyboard navigation
            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    suggestionsContainer.style.display = 'none';
                    return; // Let the form submit normally
                }
                
                if (e.key === 'Escape') {
                    suggestionsContainer.style.display = 'none';
                    searchInput.blur();
                }
            });

            // Hide suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                    suggestionsContainer.style.display = 'none';
                }
            });

            // Add keyboard shortcut for focusing search
            document.addEventListener('keydown', function(e) {
                // Ctrl+F or Cmd+F to focus search
                if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                    e.preventDefault();
                    searchInput.focus();
                    searchInput.select();
                }
            });
        }

        // Prevent dropdown from closing when clicking on search input
        document.addEventListener('DOMContentLoaded', function() {
            const dropdownInputs = document.querySelectorAll('.dropdown-menu input[type="text"]');
            dropdownInputs.forEach(input => {
                input.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            });

                    // Initialize master search
        initializeMasterSearch();
        
        // Initialize inline cell editing functionality
        initializeInlineEditing();
        
        // Debug: Show equipment IDs on current page
        const equipmentRows = Array.from(document.querySelectorAll('tr[data-equipment-id]'));
        const equipmentData = equipmentRows.map(row => ({
            id: row.getAttribute('data-equipment-id'),
            oathTag: row.getAttribute('data-oath-tag')
        }));
        console.log('Equipment data on current page:', equipmentData);
        console.log('Equipment IDs on current page:', equipmentData.map(e => e.id));
        console.log('OATH Tags on current page:', equipmentData.map(e => e.oathTag));
        if (equipmentData.length > 0) {
            console.log('First 5 equipment:', equipmentData.slice(0, 5));
        }
    });
    
    // Inline cell editing functionality
    function initializeInlineEditing() {
        const editableCells = document.querySelectorAll('.editable-cell');
        
        editableCells.forEach(cell => {
            cell.addEventListener('dblclick', function(e) {
                // Don't trigger if clicking on action buttons
                if (e.target.closest('.btn-group') || e.target.closest('.btn')) {
                    return;
                }
                
                startInlineEdit(this);
            });
            
            // Add hover effect
            cell.addEventListener('mouseenter', function() {
                this.style.backgroundColor = '#f0f8ff';
            });
            
            cell.addEventListener('mouseleave', function() {
                this.style.backgroundColor = '';
            });
        });
    }
    
    function startInlineEdit(cell) {
        const currentValue = cell.getAttribute('data-value') || cell.textContent.trim();
        const fieldName = cell.getAttribute('data-field');
        const equipmentId = cell.closest('tr').getAttribute('data-oath-tag');
        
        console.log('Starting inline edit:', {
            currentValue,
            fieldName,
            equipmentId,
            equipmentIdType: typeof equipmentId,
            cellData: {
                dataValue: cell.getAttribute('data-value'),
                dataField: cell.getAttribute('data-field')
            }
        });
        
        // Debug: Show all equipment IDs on current page
        const allEquipmentIds = Array.from(document.querySelectorAll('tr[data-equipment-id]'))
            .map(row => ({ id: row.getAttribute('data-equipment-id'), oathTag: row.getAttribute('data-oath-tag') }));
        console.log('Equipment IDs on current page:', allEquipmentIds);
        
        // Create input element
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'form-control form-control-sm';
        input.value = currentValue;
        input.style.width = '100%';
        input.style.minWidth = '120px';
        
        // Store original content
        const originalContent = cell.innerHTML;
        let isProcessing = false;
        
        // Replace cell content with input
        cell.innerHTML = '';
        cell.appendChild(input);
        input.focus();
        input.select();
        
        // Handle save on Enter or blur
        function saveEdit() {
            if (isProcessing) return; // Prevent multiple saves
            isProcessing = true;
            const newValue = input.value.trim();
            
            if (newValue !== currentValue) {
                // Show loading state
                cell.innerHTML = '<i class="bi bi-hourglass-split"></i> Saving...';
                
                // Send update request
                updateEquipmentField(equipmentId, fieldName, newValue)
                    .then(response => {
                        console.log('Processing response:', JSON.stringify(response, null, 2));
                        if (response.Success || response.success) {
                            // Update cell content and data attribute
                            cell.textContent = newValue || (fieldName === 'Assigned_User_Name' ? 'Unassigned' : 
                                                           fieldName === 'AssetCategoryId' ? 'Unknown' : 
                                                           fieldName === 'Department' ? 'Unknown' : 
                                                           fieldName === 'CurrentLocationId' ? 'Unknown' : 
                                                           fieldName === 'CurrentStatusId' ? 'Unknown' : 
                                                           fieldName === 'NetName' ? 'N/A' : 
                                                           fieldName === 'Model' ? 'Unknown' : 
                                                           fieldName === 'Serial_Number' ? 'N/A' : 'Unknown');
                            cell.setAttribute('data-value', newValue);
                            
                            // Show success indicator
                            cell.style.backgroundColor = '#d4edda';
                            setTimeout(() => {
                                cell.style.backgroundColor = '';
                            }, 1000);
                            
                            // Show success message
                            showToast('Field updated successfully!', 'success');
                        } else {
                            // Show error and restore original content
                            cell.innerHTML = originalContent;
                            cell.style.backgroundColor = '#f8d7da';
                            setTimeout(() => {
                                cell.style.backgroundColor = '';
                            }, 2000);
                            
                            // Show error message
                            showToast('Error updating field: ' + (response.Message || response.message), 'error');
                        }
                    })
                    .catch(error => {
                        // Show error and restore original content
                        cell.innerHTML = originalContent;
                        cell.style.backgroundColor = '#f8d7da';
                        setTimeout(() => {
                            cell.style.backgroundColor = '';
                        }, 2000);
                        
                        // Show error message
                        showToast('Error updating field: ' + error.message, 'error');
                    });
            } else {
                // No change, restore original content
                cell.innerHTML = originalContent;
            }
        }
        
        // Handle cancel on Escape
        function cancelEdit() {
            if (isProcessing) return; // Prevent conflicts
            isProcessing = true;
            cell.innerHTML = originalContent;
        }
        
        // Event listeners
        input.addEventListener('blur', function() {
            // Small delay to prevent DOM manipulation conflicts
            setTimeout(() => {
                if (!isProcessing) {
                    saveEdit();
                }
            }, 10);
        });
        
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveEdit();
            } else if (e.key === 'Escape') {
                e.preventDefault();
                cancelEdit();
            }
        });
    }
    
    async function updateEquipmentField(equipmentId, fieldName, value) {
        try {
            console.log('Sending update request:', { equipmentId, fieldName, value });
            console.log('Equipment ID type:', typeof equipmentId, 'Value:', equipmentId);
            
            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
            if (!token) {
                console.error('Anti-forgery token not found');
                return { Success: false, Message: 'Security token not found' };
            }
            
            const response = await fetch('/Equipment/UpdateField', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': token
                },
                body: JSON.stringify({
                    id: equipmentId,
                    field: fieldName,
                    value: value
                })
            });
            
            console.log('Response status:', response.status);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('HTTP error:', response.status, errorText);
                return { Success: false, Message: `HTTP ${response.status}: ${errorText}` };
            }
            
            const result = await response.json();
            console.log('Response data:', JSON.stringify(result, null, 2));
            return result;
        } catch (error) {
            console.error('Fetch error:', error);
            return { Success: false, Message: error.message };
        }
    }
    
    function showToast(message, type = 'info') {
        // Create toast element
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        toast.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(toast);
        
        // Auto-remove after 3 seconds
        setTimeout(() => {
            if (toast.parentNode) {
                toast.remove();
            }
        }, 3000);
    }
</script>
}

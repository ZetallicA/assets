@model Equipment
@{
    ViewData["Title"] = $"Edit Equipment - {Model.OATH_Tag}";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="card-title">
                            <i class="fas fa-edit me-2"></i>
                            Edit Equipment
                        </h3>
                        <a asp-action="Index" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>
                            Back to List
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    @if (TempData["Success"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="fas fa-check-circle me-2"></i>
                            @TempData["Success"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    <form asp-action="Edit" method="post">
                        <input type="hidden" asp-for="Id" />
                        <input type="hidden" asp-for="CreatedAt" />
                        
                        <div class="row">
                            <div class="col-md-8">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">
                                            <i class="fas fa-info-circle me-2"></i>
                                            Basic Information
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label asp-for="OATH_Tag" class="form-label">OATH Tag</label>
                                                    <input asp-for="OATH_Tag" class="form-control" readonly />
                                                    <span asp-validation-for="OATH_Tag" class="text-danger"></span>
                                                    <div class="form-text">OATH Tag cannot be changed once created.</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label asp-for="Asset_Tag" class="form-label">Asset Tag</label>
                                                    <input asp-for="Asset_Tag" class="form-control" />
                                                    <span asp-validation-for="Asset_Tag" class="text-danger"></span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label asp-for="Serial_Number" class="form-label">Serial Number</label>
                                                    <input asp-for="Serial_Number" class="form-control" />
                                                    <span asp-validation-for="Serial_Number" class="text-danger"></span>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label asp-for="Model" class="form-label">Model</label>
                                                    <input asp-for="Model" class="form-control" />
                                                    <span asp-validation-for="Model" class="text-danger"></span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label asp-for="Manufacturer" class="form-label">Manufacturer</label>
                                                    <input asp-for="Manufacturer" class="form-control" />
                                                    <span asp-validation-for="Manufacturer" class="text-danger"></span>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label asp-for="CategoryId" class="form-label">Category</label>
                                                    <select asp-for="CategoryId" class="form-select" asp-items="ViewBag.Categories">
                                                        <option value="">-- Select Category --</option>
                                                    </select>
                                                    <span asp-validation-for="CategoryId" class="text-danger"></span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label asp-for="StatusId" class="form-label">Status</label>
                                                    <select asp-for="StatusId" class="form-select" asp-items="ViewBag.Statuses">
                                                        <option value="">-- Select Status --</option>
                                                    </select>
                                                    <span asp-validation-for="StatusId" class="text-danger"></span>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label asp-for="Condition" class="form-label">Condition</label>
                                                    <select asp-for="Condition" class="form-select">
                                                        <option value="">-- Select Condition --</option>
                                                        <option value="Excellent">Excellent</option>
                                                        <option value="Good">Good</option>
                                                        <option value="Fair">Fair</option>
                                                        <option value="Poor">Poor</option>
                                                        <option value="Damaged">Damaged</option>
                                                    </select>
                                                    <span asp-validation-for="Condition" class="text-danger"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="card mt-3">
                                    <div class="card-header">
                                        <h5 class="mb-0">
                                            <i class="fas fa-calendar me-2"></i>
                                            Dates & Financial Information
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label asp-for="Purchase_Date" class="form-label">Purchase Date</label>
                                                    <input asp-for="Purchase_Date" class="form-control" type="date" />
                                                    <span asp-validation-for="Purchase_Date" class="text-danger"></span>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label asp-for="Warranty_Expiry" class="form-label">Warranty Expiry</label>
                                                    <input asp-for="Warranty_Expiry" class="form-control" type="date" />
                                                    <span asp-validation-for="Warranty_Expiry" class="text-danger"></span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label asp-for="Purchase_Cost" class="form-label">Purchase Cost</label>
                                                    <div class="input-group">
                                                        <span class="input-group-text">$</span>
                                                        <input asp-for="Purchase_Cost" class="form-control" type="number" step="0.01" />
                                                    </div>
                                                    <span asp-validation-for="Purchase_Cost" class="text-danger"></span>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label asp-for="Current_Value" class="form-label">Current Value</label>
                                                    <div class="input-group">
                                                        <span class="input-group-text">$</span>
                                                        <input asp-for="Current_Value" class="form-control" type="number" step="0.01" />
                                                    </div>
                                                    <span asp-validation-for="Current_Value" class="text-danger"></span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label asp-for="Last_Maintenance_Date" class="form-label">Last Maintenance Date</label>
                                            <input asp-for="Last_Maintenance_Date" class="form-control" type="date" />
                                            <span asp-validation-for="Last_Maintenance_Date" class="text-danger"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">
                                            <i class="fas fa-map-marker-alt me-2"></i>
                                            Location Assignment
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label asp-for="CurrentLocationId" class="form-label">Location</label>
                                            <select asp-for="CurrentLocationId" class="form-select" asp-items="ViewBag.Locations">
                                                <option value="">-- Select Location --</option>
                                            </select>
                                            <span asp-validation-for="CurrentLocationId" class="text-danger"></span>
                                        </div>

                                        <div class="mb-3">
                                            <label asp-for="CurrentFloorPlanId" class="form-label">Floor Plan</label>
                                            <select asp-for="CurrentFloorPlanId" class="form-select" asp-items="ViewBag.FloorPlans">
                                                <option value="">-- Select Floor Plan --</option>
                                            </select>
                                            <span asp-validation-for="CurrentFloorPlanId" class="text-danger"></span>
                                        </div>

                                        <div class="mb-3">
                                            <label asp-for="CurrentDeskId" class="form-label">Desk</label>
                                            <select asp-for="CurrentDeskId" class="form-select" asp-items="ViewBag.Desks">
                                                <option value="">-- Select Desk --</option>
                                            </select>
                                            <span asp-validation-for="CurrentDeskId" class="text-danger"></span>
                                        </div>
                                    </div>
                                </div>

                                <div class="card mt-3">
                                    <div class="card-header">
                                        <h5 class="mb-0">
                                            <i class="fas fa-user me-2"></i>
                                            User Assignment
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label asp-for="AssignedEntraUserId" class="form-label">Assigned User</label>
                                            <select asp-for="AssignedEntraUserId" class="form-select" asp-items="ViewBag.EntraUsers">
                                                <option value="">-- Select User --</option>
                                            </select>
                                            <span asp-validation-for="AssignedEntraUserId" class="text-danger"></span>
                                        </div>

                                        <div class="mb-3">
                                            <label asp-for="AssignedPersonId" class="form-label">Assigned Person (Legacy)</label>
                                            <select asp-for="AssignedPersonId" class="form-select" asp-items="ViewBag.Persons">
                                                <option value="">-- Select Person --</option>
                                            </select>
                                            <span asp-validation-for="AssignedPersonId" class="text-danger"></span>
                                        </div>
                                    </div>
                                </div>

                                <div class="card mt-3">
                                    <div class="card-header">
                                        <h5 class="mb-0">
                                            <i class="fas fa-sticky-note me-2"></i>
                                            Additional Information
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label asp-for="Notes" class="form-label">Notes</label>
                                            <textarea asp-for="Notes" class="form-control" rows="4" placeholder="Enter any additional notes..."></textarea>
                                            <span asp-validation-for="Notes" class="text-danger"></span>
                                        </div>

                                        <div class="mb-3">
                                            <label asp-for="IsActive" class="form-label">Status</label>
                                            <div class="form-check">
                                                <input asp-for="IsActive" class="form-check-input" />
                                                <label asp-for="IsActive" class="form-check-label">
                                                    Active
                                                </label>
                                            </div>
                                            <span asp-validation-for="IsActive" class="text-danger"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-secondary">
                                        <i class="fas fa-eye me-2"></i>
                                        View Details
                                    </a>
                                    <div>
                                        <a asp-action="Index" class="btn btn-outline-secondary me-2">
                                            <i class="fas fa-times me-2"></i>
                                            Cancel
                                        </a>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save me-2"></i>
                                            Save Changes
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        // Dynamic loading of floor plans based on selected location
        document.getElementById('CurrentLocationId').addEventListener('change', function() {
            const locationId = this.value;
            const floorPlanSelect = document.getElementById('CurrentFloorPlanId');
            const deskSelect = document.getElementById('CurrentDeskId');
            
            // Clear floor plans and desks
            floorPlanSelect.innerHTML = '<option value="">-- Select Floor Plan --</option>';
            deskSelect.innerHTML = '<option value="">-- Select Desk --</option>';
            
            if (locationId) {
                fetch(`/FloorPlan/GetFloorPlansByLocation/${locationId}`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(floorPlan => {
                            const option = document.createElement('option');
                            option.value = floorPlan.id;
                            option.textContent = `${floorPlan.floorNumber}${floorPlan.floorName ? ' - ' + floorPlan.floorName : ''}`;
                            floorPlanSelect.appendChild(option);
                        });
                    });
            }
        });

        // Dynamic loading of desks based on selected floor plan
        document.getElementById('CurrentFloorPlanId').addEventListener('change', function() {
            const floorPlanId = this.value;
            const deskSelect = document.getElementById('CurrentDeskId');
            
            // Clear desks
            deskSelect.innerHTML = '<option value="">-- Select Desk --</option>';
            
            if (floorPlanId) {
                fetch(`/FloorPlan/GetDesksByFloorPlan/${floorPlanId}`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(desk => {
                            const option = document.createElement('option');
                            option.value = desk.id;
                            option.textContent = `${desk.deskNumber}${desk.deskName ? ' - ' + desk.deskName : ''}`;
                            deskSelect.appendChild(option);
                        });
                    });
            }
        });
    </script>
}
